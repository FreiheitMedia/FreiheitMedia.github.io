<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatwoot Conversation Dashboard App â€“ DarkÂ Theme</title>

  <!-- ====================================================================
       Designâ€‘Tokens (Chatwoot DarkÂ ThemeÂ 2025â€‘07) â€“ Anlehnung an Offizielle UI
  ===================================================================== -->
  <style>
    :root {
      /* Farben */
      --cw-primary: #3b82f6;
      --cw-primary-hover: #2563eb;
      --cw-success: #22c55e;
      --cw-danger:  #ef4444;
      --cw-bg:      #1e1f24; /* GrundflÃ¤che */
      --cw-surface: #2b2d32; /* Cards, Panels */
      --cw-border:  #40424a;
      --cw-text:    #f3f4f6;
      --cw-muted:   #9ca3af;
      --cw-bubble-in: #36383d; /* eingehende Bubble */
      --cw-bubble-in-border: #50525a;
      --cw-radius:  0.5rem;
      --cw-gap:     1rem;
      --cw-font: -apple-system, BlinkMacSystemFont, "Inter",
        "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; font-family: var(--cw-font); background: var(--cw-bg); color: var(--cw-text); }

    /* ---------------- Layout ---------------- */
    .layout { display: flex; flex-direction: column; gap: var(--cw-gap); padding: var(--cw-gap); height: 100%; }
    .iframe-wrapper, .conversation-wrapper { border: 1px solid var(--cw-border); border-radius: var(--cw-radius); background: var(--cw-surface); }
    .iframe-wrapper { flex: 1 1 50%; overflow: hidden; }
    .iframe-wrapper iframe { width: 100%; height: 100%; border: none; }

    .conversation-wrapper { flex: 1 1 50%; display: flex; flex-direction: column; }

    /* ---------------- Messages ---------------- */
    #messages { flex: 1 1 auto; list-style: none; overflow-y: auto; padding: var(--cw-gap); display: flex; flex-direction: column; gap: 0.75rem; }
    .msg { position: relative; max-width: 75%; padding: 0.5rem 0.75rem; border-radius: 1.25rem; font-size: 0.875rem; line-height: 1.45; word-break: break-word; }

    .incoming { align-self: flex-start; background: var(--cw-bubble-in); border: 1px solid var(--cw-bubble-in-border); }
    .incoming::before {
      content: ""; position: absolute; left: -7px; top: 12px;
      border-width: 6px 6px 6px 0; border-style: solid;
      border-color: transparent var(--cw-bubble-in-border) transparent transparent;
    }
    .incoming::after {
      content: ""; position: absolute; left: -6px; top: 12px;
      border-width: 6px 6px 6px 0; border-style: solid;
      border-color: transparent var(--cw-bubble-in) transparent transparent;
    }

    .outgoing { align-self: flex-end; background: var(--cw-primary); color: #fff; }
    .outgoing::before {
      content: ""; position: absolute; right: -7px; top: 12px;
      border-width: 6px 0 6px 6px; border-style: solid;
      border-color: transparent transparent transparent var(--cw-primary);
    }

    .timestamp { display: block; margin-top: 0.25rem; font-size: 0.75rem; color: var(--cw-muted); }

    /* ---------------- Composer ---------------- */
    #composer { border-top: 1px solid var(--cw-border); padding: 0.5rem var(--cw-gap); display: flex; flex-direction: column; gap: 0.5rem; }

    /* Toolbar */
    #toolbar { display: flex; gap: 0.25rem; align-items: center; }
    #toolbar button { all: unset; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--cw-radius); }
    #toolbar button:hover { background: var(--cw-border); }

    #templateSelect { flex: 0 0 200px; padding: 0.375rem 0.5rem; border: 1px solid var(--cw-border); border-radius: var(--cw-radius); background: var(--cw-surface); color: var(--cw-text); font-size: 0.875rem; }
    #sendBtn { background: var(--cw-primary); color: #fff; padding: 0.5rem 1rem; border-radius: var(--cw-radius); font-size: 0.875rem; border: none; cursor: pointer; }
    #sendBtn:hover { background: var(--cw-primary-hover); }

    /* Editor */
    #editor { min-height: 80px; max-height: 180px; overflow-y: auto; padding: 0.5rem 0.75rem; border: 1px solid var(--cw-border); border-radius: var(--cw-radius); font-size: 0.875rem; background: var(--cw-bg); }
    #editor:empty:before { content: attr(placeholder); color: var(--cw-muted); }

    /* Emoji picker â€“ initially hidden */
    .emoji-picker { position: absolute; bottom: 48px; right: 1rem; background: var(--cw-surface); border: 1px solid var(--cw-border); border-radius: var(--cw-radius); box-shadow: 0 4px 16px rgba(0,0,0,.4); padding: 0.5rem; display: none; grid-template-columns: repeat(6, 24px); gap: 4px; z-index: 50; }
    .emoji-picker span { cursor: pointer; font-size: 20px; text-align: center; }
    .emoji-picker span:hover { transform: scale(1.2); }

    /* Toast */
    #toastRoot { position: fixed; right: 1rem; bottom: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 9999; }
    .toast { background: var(--cw-primary); color: #fff; padding: 0.5rem 0.75rem; border-radius: var(--cw-radius); box-shadow: 0 2px 10px rgba(0,0,0,.25); font-size: 0.875rem; }
  </style>
</head>
<body>
  <div class="layout">
    <section class="iframe-wrapper"><iframe id="dynamicFrame" src="about:blank" title="Dynamic Content"></iframe></section>

    <section class="conversation-wrapper">
      <ul id="messages"></ul>

      <form id="composer">
        <div id="toolbar">
          <button type="button" data-cmd="bold" title="Fett (Strg+B)"><strong>B</strong></button>
          <button type="button" data-cmd="italic" title="Kursiv (Strg+I)"><em>I</em></button>
          <button type="button" data-cmd="insertUnorderedList" title="Liste">â€¢â€†â€¢â€†â€¢</button>
          <select id="templateSelect"><option value="">â€’ Vorlage wÃ¤hlen â€’</option></select>
          <button id="emojiBtn" type="button" title="Emoji">ðŸ˜Š</button>
          <button id="sendBtn" type="submit">Senden</button>
        </div>
        <div id="editor" contenteditable="true" placeholder="Nachricht eingeben â€¦"></div>
      </form>
    </section>
  </div>

  <!-- Emoji Picker -->
  <div id="emojiPicker" class="emoji-picker" aria-hidden="true"></div>

  <div id="toastRoot"></div>

  <script>
    /* ============================ CONFIG ============================ */
    const CONFIG = {
      CHATWOOT_ORIGIN: "", // optional Originâ€‘Check
      N8N_SEND_WEBHOOK: "https://your-n8n-instance/webhook/send-message",
      N8N_TEMPLATES_ENDPOINT: "https://your-n8n-instance/webhook/templates",
      IFRAME_URL_TEMPLATE: "https://example.com/contact/{{EMAIL}}",
      REFRESH_INTERVAL: 4000 // ms
    };

    /* ============================ DOM ============================ */
    const messagesEl  = document.getElementById('messages');
    const dynamicFrame= document.getElementById('dynamicFrame');
    const editor      = document.getElementById('editor');
    const toolbar     = document.getElementById('toolbar');
    const templateSel = document.getElementById('templateSelect');
    const emojiBtn    = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const toastRoot   = document.getElementById('toastRoot');

    /* ============================ STATE ============================ */
    let conversationId=null, contactId=null, contactEmail=null;
    const renderedIds=new Set();
    let intervalId=null;

    /* ----- Helpers ---- */
    const b64Encode=s=>btoa(unescape(encodeURIComponent(s)));
    const b64Decode=s=>decodeURIComponent(escape(atob(s)));
    const toast=(t,d=3000)=>{const n=document.createElement('div');n.className='toast';n.textContent=t;toastRoot.appendChild(n);setTimeout(()=>n.remove(),d);};

    function renderMsg(m){ if(renderedIds.has(m.id)) return; renderedIds.add(m.id);
      const li=document.createElement('li'); li.className=`msg ${m.message_type==='incoming'?'incoming':'outgoing'}`;
      li.innerHTML=`${m.content}<span class="timestamp">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
      messagesEl.appendChild(li); messagesEl.scrollTop=messagesEl.scrollHeight; }

    function updateIframe(){ if(contactEmail) dynamicFrame.src=CONFIG.IFRAME_URL_TEMPLATE.replace('{{EMAIL}}',encodeURIComponent(contactEmail)); }
    const requestRefresh=()=>window.parent.postMessage('chatwoot-dashboard
